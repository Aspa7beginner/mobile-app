<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-16">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1">
    <title>Sensors</title>
    <link href="sensor.css" rel="stylesheet">
    <script type="text/javascript">
        sensors = ['AbsoluteOrientationSensor', 
                    'Accelerometer',
                    'AmbientLightSensor',
                    'GravitySensor',
                    'Gyroscope',
                    'LinearAccelerationSensor',
                    'Magnetometer',
                    'OrientationSensor',
                    'RelativeOrientationSensor'
        ];
        function display(){
            var results = new Array;
            sensors.forEach(function(element) {
            var de = document.createElement('div');
            if (element in window){
                de.textContent = element + ":true";
                results.push(element+":true")
            }
            else {
                de.textContent = element + ":false";
                results.push(element+":");
            }
            de.innerHtml = "something went wrong";
            document.getElementById('test').appendChild(de);
        });
        return results;
        }

    var logs = "";
    function activate(sensorName){
        logs += sensorName+"------------------";
        try {
            //accelerometer = new Accelerometer({ frequency: 10 });
            sensor = eval( `new ${sensorName}()`);
            sensor.onerror = function(event) {
                // Handle runtime errors.
                if (event.error.name === 'NotAllowedError') {
                    console.log('Permission to access sensor was denied.');
                    logs+='Permission to access sensor was denied.<br>';
                } else if (event.error.name === 'NotReadableError') {
                    console.log('Cannot connect to the sensor.');
                    logs+= sensorName + '::--->  Cannot connect to the sensor.<br>';
                }
            };                    
            sensor.onreading = function(e) {
                console.log(e);
            };
            sensor.start();
            console.log('sensor activated.');
            logs+='Sensor activated.<br>';
        } catch (error) {
            // Handle construction errors.
            if (error.name === 'SecurityError') {
                console.log('Sensor construction was blocked by the Permissions Policy.');
                logs+='Sensor construction was blocked by the Permissions Policy.<br>';
            } else if (error.name === 'ReferenceError') {
                console.log('Sensor is not supported by the User Agent.');
                logs+='Sensor is not supported by the User Agent.<br>';
            } else {
                console.log("Other error: "+ error.name);
                logs+= "Other error: "+ error.name + "<br>";
            }
        }
    }
    for (var element in window.sensors){
            console.log(window.sensors[element] + "------");
            activate(window.sensors[element]);  
    }
    function showState(){
        document.getElementById('deviceComp').innerHTML = logs;
    }

    var allSensorEvents = ['devicetemperature',
                        'devicepressure',
                        'devicelight',
                        'deviceproximity',
                        'devicenoise',
                        'devicehumidity',
                        'devicemagneticfield',
                        'atmpressure',
                        'humidity',
                        'temperature']
    window.addEventListener('load',function(){
        allSensorEvents.forEach(function(elm){
            if(elm in window && window.elm !=null){
                document.getElementById('deviceComp').appendChild(document.createTextNode("Sensor: "+elm));
            }else{
                document.getElementById('deviceComp')
                .appendChild(document.createTextNode(elm+":-->sensor event not detected or null"));
            }
        });

        let log = document.getElementById("sens-ev-val");
    // https://dvcs.w3.org/hg/dap/raw-file/tip/sensor-api/Overview.html
    window.addEventListener("devicetemperature", function (ev) {
        log.textContent += "devicetemperature " + ev.value + "\n";
    }, false);
    window.addEventListener("devicepressure", function (ev) {
        log.textContent += "devicepressure " + ev.value + "\n";
    }, false);
    window.addEventListener("devicelight", function (ev) {
        log.textContent += "devicelight " + ev.value + "\n";
        // toy tric
        log.style.color = "rgb(" + (255 - 2*ev.value) + ",0,0)";
        log.style.backgroundColor = "rgb(0,0," + (2*ev.value) + ")";
    }, false);
    window.addEventListener("deviceproximity", function (ev) {
        log.textContent += "deviceproximity " + ev.value + "\n";
        // toy tric
        if (ev.value < 3) navigator.vibrate([300, 100, 100]);
    }, false);
    window.addEventListener("devicenoise", function (ev) {
        log.textContent += "devicenoise " + ev.value + "\n";
    }, false);
    window.addEventListener("devicehumidity", function (ev) {
        log.textContent += "devicehumidity " + ev.value + "\n";
    }, false);

    //https://wiki.mozilla.org/Magnetic_Field_Events
    window.addEventListener("devicemagneticfield", function (ev) {
        log.textContent += "devicemagneticfield " + [ev.x, ev.y, ev.x]+ "\n";
    }, false);

    // https://dvcs.w3.org/hg/dap/raw-file/default/pressure/Overview.html
    window.addEventListener("atmpressure", function (ev) {
        log.textContent += "atmpressure " + ev.value + "\n";
    }, false);
    
    // https://dvcs.w3.org/hg/dap/raw-file/tip/humidity/Overview.html
    window.addEventListener("humidity", function (ev) {
        log.textContent += "humidity " + ev.value + "\n";
    }, false);
    
    // https://dvcs.w3.org/hg/dap/raw-file/tip/temperature/Overview.html
    window.addEventListener("temperature", function (ev) {
        log.textContent += "temperature " + [ev.f, ev.c, ev.k, ev.value] + "\n";
    }, false);
    });
    </script>
</head>
<body style="background-color:#2e333b; color:#abb1ba">
    <h3>Sense Awareness</h3>
    <table>
        <tr><th>Sensors</th><th>Value</th><th>Period</th></tr>
        <tr><td>ExSensor</td><td><span>Val1</span><span>Val2</span></td><td>int1</td></tr>
    </table>
<button> Send </button>
<button onclick="display()"> show </button>
<button onclick="showState()"> errors </button>
<div id="test"></div>
<div id="active"></div>
<div id="deviceComp">
</div>
</body>
</html>